name: Auto Release

on:
  pull_request:
    types: [closed]
    branches: [main, master]

# Ensure only one release workflow runs at a time to prevent conflicts
concurrency:
  group: auto-release-${{ github.ref }}
  cancel-in-progress: false  # Queue releases instead of cancelling

permissions:
  contents: read  # Default read-only

jobs:
  # Run comprehensive tests before releasing
  test:
    name: Pre-release Tests
    permissions:
      contents: read
    if: github.event.pull_request.merged == true
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # See all platform failures for better diagnostics
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy, rustfmt

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-${{ matrix.os }}-${{ matrix.rust }}"
          cache-on-failure: true

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Run tests
        run: cargo test

  auto-release:
    name: Automatic Release on Merge
    permissions:
      contents: write  # Required for pushing commits and tags
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate PR metadata
        id: validate
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [ -z "$PR_TITLE" ]; then
            echo "::error::PR title is empty. Cannot determine version bump."
            exit 1
          fi
          echo "PR title validated: $PR_TITLE"

      - name: Check if release needed
        id: check_release
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Skip if PR title contains [skip release] or [no release]
          if echo "$PR_TITLE" | grep -qiE "\[(skip|no).?release\]"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping release due to [skip release] in PR title"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust
        if: steps.check_release.outputs.skip == 'false'
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        if: steps.check_release.outputs.skip == 'false'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-edit@0.12.2

      - name: Determine version bump type
        if: steps.check_release.outputs.skip == 'false'
        id: bump_type
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          # Default to patch bump
          BUMP_TYPE="patch"
          
          # Check for breaking change indicators (major bump)
          if echo "$PR_TITLE" | grep -qiE "^(feat!|fix!):" || echo "$PR_TITLE" | grep -qiE "breaking" || echo "$PR_LABELS" | grep -qi "breaking"; then
            BUMP_TYPE="major"
          # Check for feature indicators (minor bump)
          elif echo "$PR_TITLE" | grep -qiE "^feat:" || echo "$PR_LABELS" | grep -qiE "(feature|enhancement)"; then
            BUMP_TYPE="minor"
          fi
          
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"

      - name: Bump version in Cargo.toml
        if: steps.check_release.outputs.skip == 'false'
        id: version
        run: |
          set -e  # Exit on error
          
          OLD_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          echo "ðŸ“¦ Current version: $OLD_VERSION"
          
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          echo "â¬†ï¸  Bumping $BUMP_TYPE version..."
          
          if ! cargo set-version --bump "$BUMP_TYPE"; then
            echo "::error::Failed to bump version. Check cargo-edit installation."
            exit 1
          fi
          
          NEW_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          
          if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
            echo "::error::Version did not change. Old: $OLD_VERSION, New: $NEW_VERSION"
            exit 1
          fi
          
          echo "âœ… Version bumped: $OLD_VERSION â†’ $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Cargo.lock
        if: steps.check_release.outputs.skip == 'false'
        run: |
          PACKAGE_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
          cargo update -p "$PACKAGE_NAME"

      - name: Validate version bump
        if: steps.check_release.outputs.skip == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          
          # Verify version format (semver)
          if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format: $NEW_VERSION"
            exit 1
          fi
          
          # Verify Cargo.lock was updated
          if ! git diff Cargo.lock | grep -q "+version = \"$NEW_VERSION\""; then
            echo "::error::Cargo.lock was not properly updated"
            exit 1
          fi
          
          # Verify we're not creating a duplicate version
          if git tag -l | grep -q "^v$NEW_VERSION$"; then
            echo "::error::Version v$NEW_VERSION already exists as a tag"
            exit 1
          fi
          
          echo "âœ… Version bump validated successfully"

      - name: Store version metadata for release
        if: steps.check_release.outputs.skip == 'false'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Create a version metadata file that will be included in the tag annotation
          cat > .version-metadata << EOF
          VERSION=${{ steps.version.outputs.new_version }}
          BUMP_TYPE=${{ steps.bump_type.outputs.bump_type }}
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE=${PR_TITLE}
          COMMIT_SHA=$(git rev-parse HEAD)
          EOF
          echo "âœ… Stored version metadata"

      - name: Create local commit for version bump
        if: steps.check_release.outputs.skip == 'false'
        run: |
          # Configure git for bot
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Stage version changes
          git add Cargo.toml Cargo.lock
          
          # Create local commit (won't be pushed to master)
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}" \
                     -m "" \
                     -m "This commit contains the version bump and is tagged for release." \
                     -m "It is NOT pushed to the main branch to avoid conflicts with branch protection." \
                     -m "" \
                     -m "PR: #${{ github.event.pull_request.number }}" \
                     -m "Type: ${{ steps.bump_type.outputs.bump_type }} bump" || {
            echo "::error::Failed to create version bump commit"
            exit 1
          }
          
          echo "âœ… Created local version bump commit"
          echo "ðŸ“ Commit SHA: $(git rev-parse HEAD)"

      - name: Generate release notes
        if: steps.check_release.outputs.skip == 'false'
        id: release_notes
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Find previous tag for changelog comparison
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          # Create release notes file
          cat > release_notes.md << EOF
          ## Version $NEW_VERSION
          
          **Release Type**: $BUMP_TYPE bump
          **Source PR**: #$PR_NUMBER - ${PR_TITLE}
          
          ### Changes
          This release was automatically created from PR merge.
          EOF
          
          # Add changelog link if previous tag exists
          if [ -n "$PREV_TAG" ]; then
            echo "See the [full changelog](https://github.com/${{ github.repository }}/compare/$PREV_TAG...v$NEW_VERSION) for details." >> release_notes.md
          else
            echo "This is the first release." >> release_notes.md
          fi
          
          # Add download section
          cat >> release_notes.md << EOF
          
          ### Download
          Binaries will be available shortly for:
          - ðŸ§ Linux (x86_64, x86_64-musl, ARM64)
          - ðŸŽ macOS (Intel x86_64, Apple Silicon ARM64)
          - ðŸªŸ Windows (x86_64)
          EOF
          
          echo "âœ… Generated release notes"

      - name: Create and push annotated tag
        if: steps.check_release.outputs.skip == 'false'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          TAG="v${{ steps.version.outputs.new_version }}"
          
          # Check if tag already exists (locally or remotely)
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "::warning::Tag $TAG already exists remotely. Skipping tag creation."
            echo "This may indicate a previous partial run. Please verify the release."
            exit 0
          fi
          
          # Create annotated tag on the LOCAL commit (which includes version bump)
          # This tag points to a commit that's NOT on master branch
          git tag -a "$TAG" -m "Release $TAG" \
                             -m "" \
                             -m "Version: ${{ steps.version.outputs.new_version }}" \
                             -m "Bump Type: ${{ steps.bump_type.outputs.bump_type }}" \
                             -m "PR: #${{ github.event.pull_request.number }}" \
                             -m "Title: ${PR_TITLE}" \
                             -m "" \
                             -m "This release includes binaries for Linux, macOS, and Windows." \
                             -m "See release page for download links and checksums." \
                             -m "" \
                             -m "Note: This tag points to a version bump commit that exists only for" \
                             -m "release purposes and is not merged into the main branch."
          
          # Push ONLY the tag (not the commit) to trigger release workflow
          git push origin "$TAG"
          
          echo "âœ… Created and pushed tag: $TAG"
          echo "ðŸš€ Release workflow will now build and publish binaries"
          echo "ðŸ“ Tag points to commit: $(git rev-parse $TAG)"

      - name: Create workflow summary
        if: steps.check_release.outputs.skip == 'false'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Release Created Successfully
          
          ### Release Information
          - **Version**: v${{ steps.version.outputs.new_version }}
          - **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}
          - **Source PR**: #${{ github.event.pull_request.number }} - ${PR_TITLE}
          - **Tag Commit**: $(git rev-parse HEAD | cut -c1-8)
          
          ### ðŸ“¦ Binary Build Status
          The [release workflow](https://github.com/${{ github.repository }}/actions/workflows/release.yml) is now building binaries for:
          - ðŸ§ Linux (x86_64, x86_64-musl, ARM64)
          - ðŸŽ macOS (Intel x86_64, Apple Silicon ARM64)
          - ðŸªŸ Windows (x86_64)
          
          ### ðŸ”— Links
          - [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new_version }})
          - [Download Binaries](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new_version }})
          - [All Releases](https://github.com/${{ github.repository }}/releases)
          
          > **Note**: Binaries will be available within ~10-15 minutes after the build workflow completes.
          > All binaries include SHA256 checksums for integrity verification.
          EOF
