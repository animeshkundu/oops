name: Auto Release

on:
  pull_request:
    types: [closed]
    branches: [main, master]

# Ensure only one release workflow runs at a time to prevent conflicts
concurrency:
  group: auto-release-${{ github.ref }}
  cancel-in-progress: false  # Queue releases instead of cancelling

permissions:
  contents: read  # Default read-only

jobs:
  # Run comprehensive tests before releasing
  test:
    name: Pre-release Tests
    permissions:
      contents: read
    if: github.event.pull_request.merged == true
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # See all platform failures for better diagnostics
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy, rustfmt

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-${{ matrix.os }}-${{ matrix.rust }}"
          cache-on-failure: true

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Run tests
        run: cargo test

  auto-release:
    name: Automatic Release on Merge
    permissions:
      contents: write  # Required for pushing commits and tags
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate PR metadata
        id: validate
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [ -z "$PR_TITLE" ]; then
            echo "::error::PR title is empty. Cannot determine version bump."
            exit 1
          fi
          echo "PR title validated: $PR_TITLE"

      - name: Check if release needed
        id: check_release
        run: |
          # Skip if PR title contains [skip release] or [no release]
          PR_TITLE="${{ github.event.pull_request.title }}"
          if echo "$PR_TITLE" | grep -qiE "\[(skip|no).?release\]"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping release due to [skip release] in PR title"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust
        if: steps.check_release.outputs.skip == 'false'
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        if: steps.check_release.outputs.skip == 'false'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-edit@0.12.2

      - name: Determine version bump type
        if: steps.check_release.outputs.skip == 'false'
        id: bump_type
        run: |
          # Extract PR title and labels to determine bump type
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          
          # Default to patch bump
          BUMP_TYPE="patch"
          
          # Check for breaking change indicators (major bump)
          if echo "$PR_TITLE" | grep -qiE "^(feat!|fix!):" || echo "$PR_TITLE" | grep -qiE "breaking" || echo "$PR_LABELS" | grep -qi "breaking"; then
            BUMP_TYPE="major"
          # Check for feature indicators (minor bump)
          elif echo "$PR_TITLE" | grep -qiE "^feat:" || echo "$PR_LABELS" | grep -qiE "(feature|enhancement)"; then
            BUMP_TYPE="minor"
          fi
          
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"

      - name: Bump version in Cargo.toml
        if: steps.check_release.outputs.skip == 'false'
        id: version
        run: |
          set -e  # Exit on error
          
          OLD_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          echo "ðŸ“¦ Current version: $OLD_VERSION"
          
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          echo "â¬†ï¸  Bumping $BUMP_TYPE version..."
          
          if ! cargo set-version --bump "$BUMP_TYPE"; then
            echo "::error::Failed to bump version. Check cargo-edit installation."
            exit 1
          fi
          
          NEW_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          
          if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
            echo "::error::Version did not change. Old: $OLD_VERSION, New: $NEW_VERSION"
            exit 1
          fi
          
          echo "âœ… Version bumped: $OLD_VERSION â†’ $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Cargo.lock
        if: steps.check_release.outputs.skip == 'false'
        run: |
          PACKAGE_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
          cargo update -p "$PACKAGE_NAME"

      - name: Validate version bump
        if: steps.check_release.outputs.skip == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          
          # Verify version format (semver)
          if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format: $NEW_VERSION"
            exit 1
          fi
          
          # Verify Cargo.lock was updated
          if ! git diff Cargo.lock | grep -q "+version = \"$NEW_VERSION\""; then
            echo "::error::Cargo.lock was not properly updated"
            exit 1
          fi
          
          # Verify we're not creating a duplicate version
          if git tag -l | grep -q "^v$NEW_VERSION$"; then
            echo "::error::Version v$NEW_VERSION already exists as a tag"
            exit 1
          fi
          
          echo "âœ… Version bump validated successfully"

      - name: Commit version bump
        if: steps.check_release.outputs.skip == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Cargo.toml Cargo.lock
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }} [skip ci]"

      - name: Push changes
        if: steps.check_release.outputs.skip == 'false'
        run: |
          BRANCH="${{ github.event.pull_request.base.ref }}"
          git push origin "$BRANCH"

      - name: Create and push tag
        if: steps.check_release.outputs.skip == 'false'
        run: |
          TAG="v${{ steps.version.outputs.new_version }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::warning::Tag $TAG already exists. Skipping tag creation."
            echo "This may indicate a previous partial run. Please verify the release."
            exit 0
          fi
          
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "âœ… Created and pushed tag: $TAG"

      - name: Create release summary
        if: steps.check_release.outputs.skip == 'false'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Release Summary
          
          - **Version**: ${{ steps.version.outputs.new_version }}
          - **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}
          - **PR**: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
          - **Tag**: v${{ steps.version.outputs.new_version }}
          
          ### Next Steps
          The release workflow will automatically build binaries for:
          - ðŸ§ Linux (x86_64, x86_64-musl, ARM64)
          - ðŸŽ macOS (Intel x86_64, Apple Silicon ARM64)
          - ðŸªŸ Windows (x86_64)
          
          ðŸ“¦ Binaries will be available at: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new_version }}
          EOF
